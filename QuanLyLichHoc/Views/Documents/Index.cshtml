@model IEnumerable<QuanLyLichHoc.Models.Document>
@{
    ViewData["Title"] = "Kho Tài liệu";
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h4 class="fw-bold text-primary mb-1"><i class="bi bi-folder2-open me-2"></i>Kho Tài Liệu</h4>
            <p class="text-muted small mb-0">Lớp: <strong>@ViewBag.ClassName</strong></p>
        </div>

        <div class="d-flex gap-2">
            <div class="input-group shadow-sm" style="width: 250px;">
                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Tìm tài liệu..." onkeyup="filterDocs()">
            </div>

            @if (User.IsInRole("Admin") || User.IsInRole("Lecturer"))
            {
                <button class="btn btn-primary shadow-sm fw-bold" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="bi bi-cloud-arrow-up-fill me-1"></i> Upload
                </button>
            }
        </div>
    </div>

    <div class="row g-3" id="docList">
        @if (!Model.Any())
        {
            <div class="col-12 text-center py-5">
                <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" width="100" class="mb-3 opacity-25" />
                <p class="text-muted">Chưa có tài liệu nào được tải lên.</p>
            </div>
        }

        @foreach (var item in Model)
        {
            // Logic Icon thông minh
            string ext = System.IO.Path.GetExtension(item.FilePath).ToLower();
            string iconClass = "bi-file-earmark-text text-secondary"; // Mặc định
            string bgClass = "bg-light";

            if (ext.Contains("pdf")) { iconClass = "bi-file-earmark-pdf-fill text-danger"; bgClass = "bg-danger bg-opacity-10"; }
            else if (ext.Contains("doc")) { iconClass = "bi-file-earmark-word-fill text-primary"; bgClass = "bg-primary bg-opacity-10"; }
            else if (ext.Contains("xls") || ext.Contains("csv")) { iconClass = "bi-file-earmark-excel-fill text-success"; bgClass = "bg-success bg-opacity-10"; }
            else if (ext.Contains("ppt")) { iconClass = "bi-file-earmark-ppt-fill text-warning"; bgClass = "bg-warning bg-opacity-10"; }
            else if (ext.Contains("zip") || ext.Contains("rar")) { iconClass = "bi-file-earmark-zip-fill text-dark"; bgClass = "bg-dark bg-opacity-10"; }
            else if (ext.Contains("jpg") || ext.Contains("png")) { iconClass = "bi-file-earmark-image-fill text-info"; bgClass = "bg-info bg-opacity-10"; }

            <div class="col-md-6 col-lg-4 doc-item" data-name="@item.FileName.ToLower()">
                <div class="card h-100 border-0 shadow-sm rounded-3 hover-lift position-relative overflow-hidden">
                    <div class="card-body d-flex align-items-center">
                        <div class="rounded-3 p-3 me-3 d-flex align-items-center justify-content-center @bgClass" style="width: 60px; height: 60px;">
                            <i class="bi @iconClass fs-2"></i>
                        </div>

                        <div class="flex-grow-1 overflow-hidden">
                            <h6 class="fw-bold text-dark text-truncate mb-1" title="@item.FileName">@item.FileName</h6>
                            <div class="d-flex align-items-center text-muted small">
                                <span class="me-2"><i class="bi bi-clock"></i> @item.UploadDate.ToString("dd/MM")</span>
                                <span class="badge bg-light text-secondary border">@ext.Replace(".", "").ToUpper()</span>
                            </div>
                        </div>

                        <div class="ms-2 d-flex flex-column gap-1">
                            <a href="@item.FilePath" target="_blank" class="btn btn-sm btn-light text-primary" title="Tải xuống">
                                <i class="bi bi-download"></i>
                            </a>
                            @if (User.IsInRole("Admin") || User.IsInRole("Lecturer"))
                            {
                                <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-sm btn-light text-danger"
                                   onclick="return confirm('Bạn chắc chắn muốn xóa tài liệu này?')" title="Xóa">
                                    <i class="bi bi-trash"></i>
                                </a>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-cloud-upload me-2"></i>Tải lên tài liệu</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="Upload" method="post" enctype="multipart/form-data">
                <div class="modal-body p-4">
                    <input type="hidden" name="classId" value="@ViewBag.ClassId" />

                    <div class="mb-3">
                        <label class="form-label fw-bold">Tên hiển thị</label>
                        <input type="text" name="fileName" class="form-control" placeholder="VD: Bài giảng chương 1..." required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Chọn File</label>
                        <div class="input-group">
                            <input type="file" name="file" class="form-control" id="inputFile" required>
                            <label class="input-group-text" for="inputFile"><i class="bi bi-folder2-open"></i></label>
                        </div>
                        <small class="text-muted fst-italic mt-1 d-block">Hỗ trợ: PDF, Word, Excel, PowerPoint, Zip...</small>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary fw-bold px-4">Tải lên ngay</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .hover-lift {
        transition: all 0.3s ease;
    }

        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
        }
</style>

<script>
    // Hàm tìm kiếm tài liệu (Client-side)
    function filterDocs() {
        let input = document.getElementById('searchInput').value.toLowerCase();
        let items = document.getElementsByClassName('doc-item');

        for (let i = 0; i < items.length; i++) {
            let name = items[i].getAttribute('data-name');
            if (name.includes(input)) {
                items[i].classList.remove('d-none');
            } else {
                items[i].classList.add('d-none');
            }
        }
    }
</script>